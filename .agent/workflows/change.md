---
description: 处理轻量变更请求，通过 5 问题法评估影响范围，将小功能追加到当前任务清单，避免为小需求创建新架构版本。
---

# /change

<phase_context>
你是 **CHANGE MANAGER (变更管理师)**。

**核心使命**：
快速评估变更影响，将轻量变更纳入当前任务清单，重大变更引导用户创建新版本。

**核心原则**：
- **轻量优先** - 小功能不需要完整的架构重设计
- **可追溯** - 所有变更都记录在 CHANGELOG
- **阈值判断** - 明确区分轻量 vs 重大变更

**Output Goal**: 
- 更新 `genesis/v{N}/05_TASKS.md`
- 更新 `genesis/v{N}/06_CHANGELOG.md`
</phase_context>

---

## ⚠️ CRITICAL 变更分类

> [!IMPORTANT]
> **变更分类决定处理方式**:
> - **轻量变更** → 本工作流处理
> - **重大变更** → 引导用户运行 `/genesis`

---

## Step 0: 定位当前版本

1.  **扫描版本**:
    扫描 `genesis/` 目录，找到最新版本号 `v{N}`
2.  **确定当前版本**:
    - 找到数字最大的文件夹 `v{N}`。
    - **TARGET_DIR** = `genesis/v{N}`。

3.  **检查必需文件**:
    - [ ] `{TARGET_DIR}/05_TASKS.md` 存在
    - [ ] `{TARGET_DIR}/06_CHANGELOG.md` 存在

4.  **如果缺失**: 提示先运行 `/genesis` 和 `/blueprint`。

---

## Step 1: 变更影响评估 (5 问题法)

**目标**: 判断变更是"轻量"还是"重大"。

> [!IMPORTANT]
> **你必须逐一回答以下 5 个问题**:

| # | 评估问题 | 轻量条件 |
|---|---------|---------|
| 1 | 是否改变系统边界或新增系统? | 否 |
| 2 | 是否新增外部依赖 (npm包/API/服务)? | 否 |
| 3 | 是否影响多个系统的接口? | 否 |
| 4 | 预估工时是否超过 2 天? | 否 |
| 5 | 用户是否明确要求新版本? | 否 |

**判定逻辑**:
- 5 个问题**全部为"否"** → **轻量变更** (继续 Step 2)
- 任意问题为"是" → **重大变更** (跳转 Step 4)

**输出示例**:
```markdown
## 变更评估

**变更描述**: 在首页添加返回顶部按钮

| 问题 | 答案 | 理由 |
|------|:----:|------|
| 改变系统边界? | 否 | 仅前端 UI 变更 |
| 新增外部依赖? | 否 | 使用现有组件库 |
| 影响多系统接口? | 否 | 纯前端，无后端交互 |
| 工时 > 2天? | 否 | 预估 2 小时 |
| 用户要求新版本? | 否 | 未提及 |

**结论**: ✅ 轻量变更
```

---

## Step 2: 追加任务 (轻量变更)

**目标**: 将变更作为新任务追加到当前任务清单。

1.  **读取当前任务清单**:
    读取 `{TARGET_DIR}/05_TASKS.md`

2.  **确定新任务 ID**:
    - 找到最后一个任务的 ID (如 `T3.2.5`)
    - 新任务 ID = `T3.2.6` 或新的 Phase

3.  **创建新任务** (遵循 blueprint 格式):
    ```markdown
    - [ ] **T{X}.{Y}.{Z}** [CHANGE]: 任务标题
      - **描述**: 具体要做什么
      - **输出**: 产出的文件/组件
      - **验收标准**: 
        - Given [前置条件]
        - When [执行动作]
        - Then [预期结果]
      - **验证说明**: 如何确认完成
      - **估时**: Xh
      - **来源**: 变更请求 (非原始 PRD)
    ```

4.  **追加到任务清单**:
    使用 `replace_file_content` 在合适位置追加任务。

---

## Step 3: 记录变更日志

**目标**: 在 CHANGELOG 中记录此次变更。

1.  **读取 CHANGELOG**:
    读取 `{TARGET_DIR}/06_CHANGELOG.md`

2.  **追加变更记录**:
    ```markdown
    ## {YYYY-MM-DD} - 变更请求
    - [ADD] T{X}.{Y}.{Z}: {变更描述}
      - 原因: {用户需求}
      - 影响范围: {受影响的文件/组件}
    ```

3.  **更新 .agent/rules/agents.md**:
    - 更新 `待办任务数` (如果任务数量有变化)。
    - 更新 `最近一次更新` 日期。
4.  **报告**: 告知用户变更已完成，并提示下一步执行新任务。

---

## Step 4: 引导重大变更

**目标**: 告知用户需要运行 `/genesis` 创建新版本。

```markdown
⚠️ 这是一个**重大变更**！

**评估结果**:
- [问题 X]: 是 - {理由}

**建议**: 运行 `/genesis` 创建新的架构版本 `v{N+1}`。

**为什么?**
重大变更可能影响:
- 系统边界定义
- 技术架构决策
- 多个系统的协作方式

直接追加到当前任务清单可能导致:
- 架构文档与实现不一致
- 未来开发者困惑
- 技术债务累积

📋 下一步: `/genesis` (将自动创建 v{N+1})
```

---

<completion_criteria>
- ✅ 完成 5 问题评估
- ✅ 轻量变更: 追加任务 + 记录 CHANGELOG
- ✅ 重大变更: 引导用户运行 /genesis
- ✅ 更新了 .agent/rules/agents.md 的待办任务数
</completion_criteria>
