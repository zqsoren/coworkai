# 项目代码深度分析报告

## 1. 项目概览 (Project Overview)
这是一个基于 **React + Node.js + SQLite** 的全栈 Web 应用，主要功能是**AI辅助的图像编辑与生成平台**，包含完整的用户系统、支付体系、后台管理以及基于 Fabric.js 的复杂图像编辑器。

### 技术栈 (Tech Stack)
- **前端**: React 19, Vite, TypeScript, Fabric.js (Canvas交互), TailwindCSS (推测), Lucide React (图标)。
- **后端**: Node.js (Express), SQLite3 (数据存储), JWT (认证), Multer (文件上传)。
- **AI集成**: OpenAI API (`gpt-4o`) 用于图像识别与OCR (客户端直接调用)。
- **部署**: PowerShell (`deploy_auto.ps1`) + Shell Scripts (`deploy_exec.sh`)，目标环境为 Ubuntu 服务器。

---

## 2. 核心系统模块 (Core Systems)

### 2.1 用户身份与权限系统 (Authentication & Authorization)
- **注册/登录**: 支持邮箱验证码注册、密码登录。
- **邀请机制**: 注册时支持填写`invite_code`，实现了邀请奖励逻辑（双方获得积分），防止自我邀请。
- **JWT认证**: 使用 `jsonwebtoken` 生成双效 Token (48小时有效期)。
- **心跳机制**: 前端定期发送心跳 (`/api/user/heartbeat`) 统计用户在线时长 (`total_login_duration`)。

### 2.2 积分与会员系统 (Credits & Membership)
- **积分体系**: `remaining_credits` (剩余积分/次数)，用于扣减生成消耗。
- **会员等级**: 分为 `free`, `pro`, `ultra`，根据充值金额自动升级 (`updateMembershipLevel`)。
- **支付充值**: 支持手动/自动充值订单 (`recharge_records`)，后台管理员可审核通过 (`/api/admin/orders/:id/status`)。

### 2.3 图像生成与管理系统 (Image Generation)
- **提示词库 (Prompt Library)**: 三级分类结构 `Category -> Subtype -> Style`。
  - 支持 **高级配置** (`advanced_settings` 表)，存储 JSON 格式的复杂参数。
  - 支持 **参考图 (Ref Image)** 与 **提示图 (Hint Image)** 上传。
- **生成记录**: 记录所有用户的生成历史 (`generation_records`)，包含 Prompt、参数、结果图 URL。
- **画廊 (Gallery)**: 展示用于项目或公开的生成图片。

### 2.4 智能编辑器 (Smart Editor)
- **核心组件**: `ImageFocusEditorModal.tsx`。
- **功能**:
  - 基于 `Fabric.js` 的画布操作（移动、缩放、绘图）。
  - **AI 智能识别**: 集成 OpenAI `gpt-4o` Vision 模型，识别建筑图纸中的文字标签，并自动转换为可编辑的 Canvas 对象（"✨ AI Smart Recognition"）。
  - **OCR**: 集成 `tesseract.js` 进行本地 OCR 识别。
  - 图层管理、属性编辑。

### 2.5 后台管理系统 (Admin Panel)
- **仪表盘**: 展示用户总量、日活、总生成数、总运行时长。
- **用户管理**: 查看所有用户详情（手机、邮箱、积分），支持封禁/解封、修改积分、重置密码。
- **订单管理**: 审核充值订单，处理“待支付”或“手动转账”的请求。
- **提示词管理**: 全功能的 CRUD 界面，管理提示词分类、样式、预览图及是否精选。
- **系统设置**: 动态调整积分成本 (`points_per_generation`)、注册奖励 (`register_credits`) 等全局参数。

---

## 3. 数据模型 (Data Model - SQLite)

从 `update_db_schema.cjs` 和 `server.js` 分析，主要数据表如下：

| 表名 | 描述 | 关键字段 |
| :--- | :--- | :--- |
| `users` | 用户表 | `username`, `email`, `password`, `role`, `remaining_credits`, `invite_code`, `membership_level` |
| `generation_records` | 生成记录 | `user_id`, `prompt`, `image_url`, `base_json`, `advanced_settings` |
| `prompt_styles` | 提示词样式 | `subtype_id`, `prompt_content`, `config_json` (关联), `is_featured` |
| `prompt_categories` | 提示词一级分类 | `name`, `sort_order` |
| `prompt_subtypes` | 提示词二级分类 | `category_id`, `name`, `icon` |
| `advanced_settings` | 高级生成配置 | `style_id`, `config_json` (JSON格式的复杂配置) |
| `recharge_records` | 充值订单 | `user_id`, `amount`, `status` ('pending'/'completed'), `payment_method` |
| `system_settings` | 全局配置 | `key`, `value` (如积分单价、邀请奖励数额) |
| `verification_codes` | 验证码 | `email`, `code`, `expires_at` |
| `projects` | 项目/收藏夹 | `user_id`, `name`, `is_pinned` |

---

## 4. 目录结构说明 (Directory Structure)

```
/
├── .agent/                 # Agent 配置与工作流 (AI 辅助开发相关)
├── components/             # React 组件 (UI)
│   ├── admin/              # 后台管理组件
│   ├── editor/             # 图像编辑器组件 (核心)
│   └── ...
├── deploy-package/         # 部署相关脚本备份
├── dist/                   # 前端构建产物 (Vite build output)
├── pages/                  # 页面级组件 (路由入口)
├── public/                 # 静态资源
├── server/                 # Node.js 后端代码
│   ├── routes/             # API 路由 (admin.js, users.js, prompts.js)
│   ├── uploads/            # 用户上传/生成的文件存储
│   ├── server.js           # 后端入口 & 数据库初始化
│   └── update_db_schema.cjs # 数据库迁移脚本
├── deploy_auto.ps1         # Windows 端自动部署脚本
├── vite.config.ts          # Vite 配置
└── package.json            # 项目依赖配置
```

## 5. 总结 (Summary)
这是一个功能相当完善的 **SaaS 初形** 项目。
- **优点**: 结构清晰，前后端分离但同库管理（便于开发），数据库自动化迁移脚本健壮 (`update_db_schema.cjs` 写得很好)，拥有完善的后台管理功能，商业化路径（积分、充值）已经打通。
- **特色**: 结合了传统的 Web 业务系统与现代的 AI 能力（Canvas 编辑器 + LLM 视觉识别）。
